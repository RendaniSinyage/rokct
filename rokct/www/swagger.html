<!DOCTYPE html>
<html>
<head>
    <title>PLATFORM API</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swagger-ui-dist@3/swagger-ui.css">
    <link rel="icon" href="/assets/rokct/images/logo.svg" type="image/svg+xml">

    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
        }

        .swagger-ui .topbar {
            background-color: #2c3e50;
        }

        .swagger-ui .topbar .topbar-wrapper a {
            color: #fff;
        }

        .swagger-ui .info h2, .swagger-ui .info p {
            color: #2c3e50;
        }

        /* Add footer spacing */
        .swagger-ui {
            padding-bottom: 100px;
        }

        /* Styles for the loading spinner */
        #loading-spinner-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            background-color: white;
            flex-direction: column;
        }

        .loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .pagination-controls, .download-btn-container {
            text-align: center;
            margin-top: 20px;
        }

        .pagination-controls button, .download-btn-container button {
            padding: 10px 20px;
            margin: 0 5px;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
            cursor: pointer;
        }

        .pagination-controls button:disabled {
            background-color: #e0e0e0;
            cursor: not-allowed;
        }

        /* Header row with logo + module select */
        #header-row {
            position: absolute;
            top: 15px;
            left: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #header-row .header-logo {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #header-row .header-logo img {
            height: 35px;
        }

        #header-row .header-logo .header-text {
            font-size: 20px;
            font-family: "Open Sans", sans-serif;
            font-weight: bold;
            color: #2c3e50;
        }

        #module-selection {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #module-selection label {
            color: #333;
            font-size: 14px;
            font-weight: 500;
        }

        #module-selection select {
            padding: 6px 30px 6px 12px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: white;
            min-width: 200px;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 8px center;
            background-repeat: no-repeat;
            background-size: 16px;
        }

        #module-selection select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        /* Loading indicator for module changes */
        #module-loading {
            display: none;
            margin-left: 10px;
            font-size: 12px;
            color: #666;
        }

        #module-loading.visible {
            display: inline-block;
        }

        /* Updated download buttons - smaller and positioned below title */
        .download-btn-container {
            position: absolute;
            top: 120px;
            left: 20px;
            text-align: left;
            margin-top: 10px;
            z-index: 1000;
        }

        .download-btn-container button {
            padding: 6px 12px;
            margin: 0 5px 0 0;
            border: 1px solid #ccc;
            background-color: #f8f9fa;
            cursor: pointer;
            font-size: 12px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .download-btn-container button:hover {
            background-color: #e9ecef;
        }

        .download-btn-container button:disabled {
            background-color: #e0e0e0;
            cursor: not-allowed;
            opacity: 0.6;
        }

        #download-current-btn {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }

        #download-current-btn:hover:not(:disabled) {
            background-color: #2980b9;
        }

        #download-full-btn {
            background-color: #2c3e50;
            color: white;
            border-color: #2c3e50;
        }

        #download-full-btn:hover:not(:disabled) {
            background-color: #34495e;
        }

        /* License link under download buttons */
        .license-link {
            margin-top: 8px;
        }

        .license-link a {
            font-size: 13px;
            color: #3498db;
            text-decoration: none;
        }

        .license-link a:hover {
            text-decoration: underline;
        }

        /* Error message styling */
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 20px;
            margin: 20px;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <div id="loading-spinner-container">
        <div class="loader"></div>
        <div id="doctype-stats-container" style="text-align: center; margin-top: 20px; font-weight: bold; display: none;">
            <p><strong>Total:</strong> <span id="total-doctypes"></span></p>
            <p><strong>Processed:</strong> <span id="processed-doctypes"></span></p>
        </div>
        <div id="loading-status" style="text-align: center; margin-top: 10px; color: #666;">
            Initializing...
        </div>
    </div>

    <!-- Header row -->
    <div id="header-row">
        <div class="header-logo">
            <img src="/assets/rokct/images/logo_dark.svg" alt="ROKCT Logo" />
            <span class="header-text">ROKCT</span>
        </div>
        <div id="module-selection" style="display: none;">
            <label for="module-dropdown">Select a Module</label>
            <select id="module-dropdown">
                <option value="">Select a module...</option>
            </select>
            <span id="module-loading">Loading...</span>
        </div>
    </div>

    <div id="swagger-ui" style="display: none;"></div>

    <div class="download-btn-container" style="display: none;">
        <button id="download-current-btn" disabled>
            Download Current View JSON
        </button>
        <button id="download-full-btn" disabled>
            Download Full JSON
        </button>
        <div class="license-link">
            <a href="https://www.gnu.org/licenses/agpl-3.0.html" target="_blank">Publication License (AGPLv3)</a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/swagger-ui-dist@3/swagger-ui-bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/swagger-ui-dist@3/swagger-ui-standalone-preset.js"></script>
    <script>
        window.onload = function () {
            let modulesData = {};
            let currentModuleSpec = {};
            const loadingSpinnerContainer = document.getElementById('loading-spinner-container');
            const loadingStatus = document.getElementById('loading-status');
            const swaggerUiContainer = document.getElementById('swagger-ui');
            const moduleSelection = document.getElementById('module-selection');
            const moduleDropdown = document.getElementById('module-dropdown');
            const moduleLoading = document.getElementById('module-loading');
            const downloadBtnContainer = document.querySelector('.download-btn-container');
            const downloadCurrentBtn = document.getElementById('download-current-btn');
            const downloadFullBtn = document.getElementById('download-full-btn');

            const showError = (message) => {
                loadingSpinnerContainer.style.display = 'none';
                swaggerUiContainer.innerHTML = `<div class="error-message">${message}</div>`;
                swaggerUiContainer.style.display = 'block';
            };

            const updateLoadingStatus = (status) => {
                loadingStatus.textContent = status;
            };

            const renderSwaggerUI = (spec) => {
                window.ui = SwaggerUIBundle({
                    spec: spec,
                    dom_id: "#swagger-ui",
                    presets: [
                        SwaggerUIBundle.presets.apis,
                        SwaggerUIStandalonePreset
                    ],
                    plugins: [
                        SwaggerUIBundle.plugins.DownloadUrl
                    ],
                    layout: "BaseLayout",
                    docExpansion: "none",
                    defaultModelsExpandDepth: 1,
                    displayOperationId: true,
                    requestInterceptor: (request) => {
                        request.headers["X-Frappe-CSRF-Token"] = null;
                        return request;
                    },
                    onComplete: () => {
                        // Custom logo in Swagger top bar
                        const topbar = document.querySelector(".swagger-ui .topbar-wrapper");
                        if (topbar) {
                            topbar.innerHTML = `
                                <div class="custom-topbar-logo">
                                    <img src="/assets/rokct/images/logo_dark.svg" alt="ROKCT.ai Logo" onerror="this.style.display='none'" />
                                    <span>${spec.info.title}</span>
                                </div>
                            `;
                        }
                    }
                });

                loadingSpinnerContainer.style.display = 'none';
                swaggerUiContainer.style.display = 'block';
                moduleSelection.style.display = 'flex';
                downloadBtnContainer.style.display = 'block';

                // Enable download buttons
                downloadCurrentBtn.disabled = false;
                downloadFullBtn.disabled = false;
            };

            const loadModuleSpec = async (moduleName) => {
                try {
                    moduleLoading.classList.add('visible');
                    updateLoadingStatus(`Loading ${moduleName} module...`);

                    // Create safe filename
                    const safeModuleName = moduleName.replace(/[^a-zA-Z0-9\-_]/g, '');
                    const response = await fetch(`/assets/rokct/api/module-${safeModuleName}.json`);

                    if (!response.ok) {
                        throw new Error(`Failed to load module ${moduleName}: ${response.status}`);
                    }

                    const moduleSpec = await response.json();
                    currentModuleSpec = moduleSpec;
                    renderSwaggerUI(moduleSpec);

                } catch (error) {
                    console.error(`Error loading module ${moduleName}:`, error);
                    showError(`Failed to load module "${moduleName}". Please try again or select a different module.`);
                } finally {
                    moduleLoading.classList.remove('visible');
                }
            };

            const initializeSwaggerUI = async () => {
                try {
                    updateLoadingStatus('Loading modules list...');

                    // First, load the modules list
                    const modulesResponse = await fetch("/assets/rokct/api/modules.json");
                    if (!modulesResponse.ok) {
                        throw new Error(`Failed to load modules: ${modulesResponse.status}`);
                    }

                    modulesData = await modulesResponse.json();
                    const modules = modulesData.modules || [];

                    // Populate the module dropdown
                    modules.forEach(moduleName => {
                        const option = document.createElement('option');
                        option.value = moduleName;
                        option.innerText = moduleName;
                        moduleDropdown.appendChild(option);
                    });

                    if (modules.length > 0) {
                        // Set EDI as default, fallback to first module if EDI doesn't exist
                        const defaultModule = modules.includes('EDI') ? 'EDI' : modules[0];
                        moduleDropdown.value = defaultModule;
                        await loadModuleSpec(defaultModule);
                    } else {
                        showError('No modules found.');
                    }

                } catch (error) {
                    console.error("Failed to initialize Swagger UI:", error);
                    showError('Error loading API documentation. Please check your connection and try again.');
                }
            };

            // Event listener for module dropdown changes
            moduleDropdown.addEventListener('change', async (event) => {
                const selectedModule = event.target.value;
                if (selectedModule) {
                    loadingSpinnerContainer.style.display = 'flex';
                    swaggerUiContainer.style.display = 'none';
                    downloadBtnContainer.style.display = 'none';

                    await loadModuleSpec(selectedModule);
                }
            });

            // Download current view JSON
            downloadCurrentBtn.addEventListener('click', () => {
                try {
                    const spec = window.ui ? window.ui.specSelectors.specJson().toJS() : currentModuleSpec;
                    const moduleName = moduleDropdown.value || 'current';
                    const blob = new Blob([JSON.stringify(spec, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${moduleName}-swagger.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } catch (error) {
                    console.error('Error downloading current view:', error);
                    alert('Error downloading current view. Please try again.');
                }
            });

            // Download full JSON
            downloadFullBtn.addEventListener('click', async () => {
                try {
                    downloadFullBtn.disabled = true;
                    downloadFullBtn.textContent = 'Downloading...';

                    // FIXED: Changed the fetch URL to the correct filename
                    const response = await fetch('/assets/rokct/api/swagger-full.json');
                    if (!response.ok) {
                        throw new Error(`Failed to load full swagger: ${response.status}`);
                    }

                    const fullSpec = await response.json();
                    const blob = new Blob([JSON.stringify(fullSpec, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    // FIXED: Corrected the download filename
                    a.download = 'full-swagger.json';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                } catch (error) {
                    console.error('Error downloading full swagger:', error);
                    alert('Error downloading full documentation. Please try again.');
                } finally {
                    downloadFullBtn.disabled = false;
                    downloadFullBtn.textContent = 'Download Full JSON';
                }
            });

            // Initialize the application
            initializeSwaggerUI();
        };
    </script>
</body>
</html>
